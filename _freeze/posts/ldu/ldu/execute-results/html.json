{
  "hash": "9a1fc6f6bcc442bc1c696e3d56012307",
  "result": {
    "markdown": "---\ntitle: \"El trono en Ponceano: \"\nauthor: \"Daniel Sánchez\"\ndate: \"2023-10-26\"\ndescription: \"Liga Deportiva Universitaria demuestra una vez más su potencial internacional pasando a la final de la Copa Sudamericana 2023. En este post, hago un intento de *football analytics* mediante... Imagen generada con inteligencia artificial.\"\ncategories: [spanish, ecuador, football, data viz, R]\ncsl: ../../econometrics.csl\nimage: ldu_thumb.jpeg\ndraft: true\nknitr:\n  opts_chunk: \n    message: false\n    warning: false\n    echo: true\n    include: true\nformat:\n  html:\n    code-fold: true\n    code-tools: true\n    code-summary: \"Show the code\"\n    code-overflow: wrap\n---\n\n\nDespués de casi 14 años desde su última final en un campeonato internacional, Liga Deportiva Universitaria de Quito (LDU) selló su pase a la final de la Copa Sudamericana (el segundo campeonato más importante del fútbol de clubes en Sudamérica). El triunfo de Liga no viene fácil: aunque se ganó la fama del *Rey de Copas* por los cuatro títulos internacionales ganados durante 2007-2010 (incluyendo la Copa Libertadores, el título más importante de América, nunca antes ganado por otro equipo ecuatoriano), al equipo le ha costado restaurar su gloria desde entonces. El 28 de Octubre Liga promete desempolvar el trono en Ponceano, el barrio de Quito donde se encuentra el Estadio Rodrigo Paz Delgado, la *Casa Blanca*. En homenaje al equipo y en la misma línea de los otros artículos de este blog, en este post reviso la trayectoria de Liga en la Copa Sudamericana mediante.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Cargar librerias\n\nlibrary(worldfootballR)\nlibrary(dplyr)\nlibrary(stringr)\nlibrary(tidyr)\nlibrary(ggplot2)\nlibrary(ggthemes)\nlibrary(showtext)\n\n# Definir tema base\n\nfont_add_google(\"Questrial\", family = \"Questrial\")\nshowtext_auto()\n\ntheme_daniel<-\n  theme_hc(style = 'darkunica',\n           base_family = 'Questrial',\n           base_size = 40) +\n  theme(axis.line.y = element_line(colour = 'white'),\n        axis.line.x = element_blank(),\n        panel.grid.major.y = element_blank(),\n        panel.grid.major.x = element_blank(),\n        plot.caption = element_text(hjust = 0, face = 'italic'),\n        plot.title.position = 'plot',\n        plot.caption.position = 'plot',\n        plot.subtitle = element_text(lineheight = 0.5, vjust = 0.5),\n        axis.ticks = element_blank(),\n        plot.title = element_text(size = 60),\n        axis.text = element_text(colour = 'gray'))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Loop para extraer informacion-copa-sudamericana\n\nyears <- seq(2014, 2022)\n\nsudamericana <- list()\n\nfor (i in years){\n  sudamericana[[which(years == i)]] <- fb_league_stats(gender = 'M',\n                                                       season_end_year = i,\n                                                       team_or_player = 'team',\n                                                       non_dom_league_url = \"https://fbref.com/en/comps/205/history/Copa-Sudamericana-Seasons\",\n                                                       stat_type = 'standard',\n                                                       country = NA,\n                                                       tier = NA)\n}\n\n# Extraer como un solo df y preparar\n\nsudamericana_df <- \n  bind_rows(sudamericana)  %>% \n  janitor::clean_names()  %>% \n  mutate(year = case_when(\n    url  %>% str_like('%2014%') ~ 2014,\n    url  %>% str_like('%2015%') ~ 2015,\n    url  %>% str_like('%2016%') ~ 2016,\n    url  %>% str_like('%2017%') ~ 2017,\n    url  %>% str_like('%2018%') ~ 2018,\n    url  %>% str_like('%2019%') ~ 2019,\n    url  %>% str_like('%2020%') ~ 2020,\n    url  %>% str_like('%2021%') ~ 2021,\n    url  %>% str_like('%2022%') ~ 2022,                                                        \n  ),\n  country = str_sub(squad, start = 1, end = 2)  %>% str_to_upper(),\n  team = str_sub(squad, start = 4, end = -1))  %>% \n  select(-squad)\n\n# Filtrar para entradas de LDU\n\nsudamericana_ldu <-\n  sudamericana_df  %>%\n  filter(team == 'LDU de Quito')\n\n# Extraer informacion de Copa Libertadores \n\nlibertadores <- list()\n\nfor (i in years){\n  libertadores[[which(years == i)]] <- fb_league_stats(gender = 'M',\n                                                       season_end_year = i,\n                                                       team_or_player = 'team',\n                                                       non_dom_league_url = \"https://fbref.com/en/comps/14/history/Copa-Libertadores-Seasons\",\n                                                       stat_type = 'standard',\n                                                       country = NA,\n                                                       tier = NA)\n}\n\n# Extraer como df y preparar\n\nlibertadores_df <- \n  bind_rows(libertadores)  %>% \n  janitor::clean_names()  %>% \n  mutate(year = case_when(\n    url  %>% str_like('%2014%') ~ 2014,\n    url  %>% str_like('%2015%') ~ 2015,\n    url  %>% str_like('%2016%') ~ 2016,\n    url  %>% str_like('%2017%') ~ 2017,\n    url  %>% str_like('%2018%') ~ 2018,\n    url  %>% str_like('%2019%') ~ 2019,\n    url  %>% str_like('%2020%') ~ 2020,\n    url  %>% str_like('%2021%') ~ 2021,\n    url  %>% str_like('%2022%') ~ 2022,                                                        \n  ),\n  country = str_sub(squad, start = 1, end = 2)  %>% str_to_upper(),\n  team = str_sub(squad, start = 4, end = -1))  %>% \n  select(-squad)\n\n#  Filtrar para entradas de LDU\n\nlibertadores_ldu <-\n  libertadores_df  %>%\n  filter(team == 'LDU de Quito')\n\n# Extraemos datos de partidos de Copa Sudamericana y Copa Libertadores desde 2014\n\nlibertadores_matches_raw <- load_match_comp_results('Copa Libertadores de América')\n\nsudamericana_matches_raw <- load_match_comp_results('Copa Sudamericana')\n\n# Preparar datos de Copa Libertadores\n\nlibertadores_matches <-\n  libertadores_matches_raw  %>% \n  janitor::clean_names()  %>%\n  transmute(competition_name = iconv(competition_name, from = \"UTF-8\", to = \"latin1\"),\n            year = season_end_year,\n            round,\n            round_number = case_when(\n              round == 'First stage' ~ 1,\n              round %in% c('Second stage', 'Group stage') ~ 2,\n              round == 'Knockout round play-offs' ~ 3,\n              round == 'Round of 16' ~ 4,\n              round == 'Quarter-finals' ~ 5,\n              round == 'Semi-finals' ~ 6,\n              round %in% c('Final', 'Finals') ~ 7\n            ),\n            day,\n            date,\n            time,\n            home_team_country = str_sub(home, start = -2)  %>% str_to_upper(),\n            home_team_name = str_sub(home, end = -4),\n            home_goals,\n            away_team_country = str_sub(away, start = 1, end = 2)  %>% str_to_upper(),\n            away_team_name = str_sub(away, start = 4, end = -1),\n            away_goals,\n            result = case_when(\n              home_goals > away_goals ~ 'home_win',\n              home_goals < away_goals ~ 'away_win',\n              home_goals == away_goals ~ NA),\n            match_winner = case_when(\n              home_goals > away_goals ~ home_team_name,\n              home_goals < away_goals ~ away_team_name,\n              home_goals == away_goals ~ 'none-draw'),\n            leg = case_when(\n              notes  %>% str_like('%Leg 1%') ~ 'leg_1',\n              notes  %>% str_like('%Leg 2%') ~ 'leg_2',\n              TRUE ~ NA\n            ),\n            penalty_kicks = if_else(notes  %>% str_like('%penalties%'), TRUE, FALSE),\n            extra_time = if_else(notes  %>% str_like('%extra time%'), TRUE, FALSE),\n            venue,\n            attendance,\n            referee,\n            notes)\n\n# Preparar datos de Copa Sudamericana\n\nsudamericana_matches <-\n  sudamericana_matches_raw  %>% \n  janitor::clean_names()  %>% \n  transmute(competition_name,\n            year = season_end_year,\n            round,\n            round_number = case_when(\n              round == 'First stage' ~ 1,\n              round %in% c('Second stage', 'Group stage') ~ 2,\n              round == 'Knockout round play-offs' ~ 3,\n              round == 'Round of 16' ~ 4,\n              round == 'Quarter-finals' ~ 5,\n              round == 'Semi-finals' ~ 6,\n              round %in% c('Final', 'Finals') ~ 7\n            ),\n            day,\n            date,\n            time,\n            home_team_country = str_sub(home, start = -2)  %>% str_to_upper(),\n            home_team_name = str_sub(home, end = -4),\n            home_goals,\n            away_team_country = str_sub(away, start = 1, end = 2)  %>% str_to_upper(),\n            away_team_name = str_sub(away, start = 4, end = -1),\n            away_goals,\n            result = case_when(\n              home_goals > away_goals ~ 'home_win',\n              home_goals < away_goals ~ 'away_win',\n              home_goals == away_goals ~ NA),\n            match_winner = case_when(\n              home_goals > away_goals ~ home_team_name,\n              home_goals < away_goals ~ away_team_name,\n              home_goals == away_goals ~ 'none-draw'),\n            leg = case_when(\n              notes  %>% str_like('%Leg 1%') ~ 'leg_1',\n              notes  %>% str_like('%Leg 2%') ~ 'leg_2',\n              TRUE ~ NA\n            ),\n            penalty_kicks = if_else(notes  %>% str_like('%penalties%'), TRUE, FALSE),\n            extra_time = if_else(notes  %>% str_like('%extra time%'), TRUE, FALSE),\n            venue,\n            attendance,\n            referee,\n            notes)\n\n# Filtrar para datos de LDU en Copa Libertadores solamente\n\nlibertadores_matches_ldu <-\n  libertadores_matches  %>% \n  filter(home_team_name == 'LDU de Quito' | away_team_name == 'LDU de Quito')\n\n# Obtener la ultima etapa alcanzada para cada año de LDU\n\nldu_stage_reached_libertadores <-\n  libertadores_matches_ldu  %>% \n  group_by(year)  %>% \n  summarise(stage_reached_libertadores = max(round_number, na.rm = T))\n\n# Filtrar para datos de LDU en Copa Sudamericana solamente\n\nsudamericana_matches_ldu <-\n  sudamericana_matches  %>%\n  filter(home_team_name == 'LDU de Quito' | away_team_name == 'LDU de Quito')\n\n# Obtener la ultima etapa alcanzada para cada año de LDU\n\nldu_stage_reached_sudamericana <-\n  sudamericana_matches_ldu  %>% \n  group_by(year)  %>%\n  summarise(stage_reached_sudamericana = max(round_number, na.rm = T))\n\n# Crear data frame para realizar grafico de resultados LDU en campeonatos internacionales \n\ninternational_results_ldu <-\n  data.frame(year = seq(2014, 2023))  %>% \n  left_join(ldu_stage_reached_libertadores, by = 'year')  %>% \n  left_join(ldu_stage_reached_sudamericana, by = 'year')  %>% \n  mutate(stage_reached_libertadores = tidyr::replace_na(stage_reached_libertadores, 0.1),\n         stage_reached_sudamericana = tidyr::replace_na(stage_reached_sudamericana, 0.1),\n         stage_reached = pmax(stage_reached_libertadores, stage_reached_sudamericana),\n         label_libertadores = case_when(\n            stage_reached_libertadores == 0 ~ 'No participó',\n            stage_reached_libertadores  %>% between(1,3) ~ 'Fase de grupos',\n            stage_reached_libertadores == 3 ~ 'Repechaje',\n            stage_reached_libertadores == 4 ~ 'Octavos de final',\n            stage_reached_libertadores == 5 ~ 'Cuartos de final',\n            stage_reached_libertadores == 6 ~ 'Semifinal',\n            stage_reached_libertadores == 7 ~ 'Final'),\n          label_sudamericana = case_when(\n            stage_reached_sudamericana == 0 ~ 'No participó',\n            stage_reached_sudamericana  %>% between(1,3) ~ 'Fase de grupos',\n            stage_reached_sudamericana == 3 ~ 'Repechaje',\n            stage_reached_sudamericana == 4 ~ 'Octavos de final',\n            stage_reached_sudamericana == 5 ~ 'Cuartos de final',\n            stage_reached_sudamericana == 6 ~ 'Semifinal',\n            stage_reached_sudamericana == 7 ~ 'Final')\n          )\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Grafico de resultados LDU en campeonatos internacionales\n\ninternational_results_ldu  %>%\n  ggplot(aes(x = year, y = stage_reached_sudamericana)) +\n  geom_col(width = 0.8, fill = 'white', colour = '#C7B143') + \n  geom_text(aes(label = label_sudamericana), vjust = -0.5, size = 3.5) +\n  scale_x_continuous(breaks = seq(2014, 2023, 1)) +\n  labs(x = '',\n       y = '',\n       title = 'Resultados de Copa Sudamericana')+\n  theme_daniel+\n  theme(axis.line.y = element_blank(),\n        axis.text.y = element_blank())\n```\n\n::: {.cell-output-display}\n![](ldu_files/figure-html/grafico-resultados-1.png){width=1152}\n:::\n:::\n",
    "supporting": [
      "ldu_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}